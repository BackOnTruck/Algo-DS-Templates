### 动态dp

###### 问题

对于一类dp问题, 我们需要多次修改某些值并重新计算dp值.

例如动态树上最大权值独立集问题: 对于一棵$n$个点的树, 每个点有一个权值. 给定$m$次修改, 每次更改一个点的权值. 你需要在每次修改后回答最大权值独立集. $n,m\le 10^5$.

###### 解答

记$f(u,0/1)$为不选/选$u$时其所在子树的答案. dp方程显然:
$$
f(u,0)=\sum_{v\in son(u)}\max\{f(v,0),f(v,1)\}\\
f(u,1)=w(u)+\sum_{v\in son(u)}f(v,0)
$$

我们引入树链剖分(HLD), 引入辅助状态$g$. 定义点$u$的**轻链子树**表示$u$所在子树除去$u$所在重链加上$u$的部分.

$g(u,0/1)$表示不选/选$u$时其**轻链子树**的答案. 定义$i+1$表示$i$的**重链儿子**. 则有:
$$
f(i,0)=g(i,0)+\max\{f(i+1,0),f(i+1,1)\}\\
f(i,1)=g(i,1)+f(i+1,0)
$$

我们用`+`和`max`重新定义矩阵乘法 (依然满足结合律):
$$
AB=C~\iff c_{ij}=\max_k\{a_{ik}+b_{kj}\}
$$
则有:
$$
(\begin{matrix}g(i,0)~~~~g(i,0)\\g(i,1)~~~~~-\infin\end{matrix})(\begin{matrix}f(i+1,0)\\f(i+1,1)\end{matrix})=(\begin{matrix}f(i,0)\\f(i,1)\end{matrix})
$$
**注意: 代码实现中, 为了避免溢出, 可以用$0$代替$-\infin$.**

我们维护所有顶点的$g$矩阵, 只维护**重链顶点**的$f$矩阵.

对于叶子结点$i​$, 我们可以特殊处理:
$$
(\begin{matrix}g(i,0)~~~~g(i,0)\\g(i,1)~~~~~-\infin\end{matrix})(\begin{matrix}0\\0\end{matrix})=(\begin{matrix}f(i,0)\\f(i,1)\end{matrix})
$$
修改点$u$时更改$g(u,1)$, 重新计算$u$的重链的顶部$t$点的$f(t)$, $t$的父亲$p$的$g(p)$, $p$的重链顶部$q$的$f(q)$, 一直到$f(1)$.

修改完成后答案为$\max\{f(1,0),f(1,1)\}$.

总复杂度$O(8n\log^2n)$.